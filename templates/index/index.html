{% extends "./layout-index.html" %}
{% block content %}
<link rel="stylesheet" href="{% static 'css/index_style.css' %}">
<div class="main-container">
    <button class="layui-btn layui-btn-primary layui-btn-radius article-choose" style="right: 10px; position: absolute;">
        <span>文章筛选</span>
        <i class="layui-icon layui-icon-down layui-font-12"></i>
      </button>
    <div class="post-list" id="post-list">
        {% for post in posts %}
        <a href="{% url 'post' %}?id={{ post.id }}" class="post-card">
            <div class="post-card-img" id="post-{{post.id}}"></div>
            <div class="post-card-text">
                <h2>{{ post.title }}</h2>
                <p>
                    <span style="float: left;">{{ post.author }} {{ post.created_at }} </span>
                    <span style="float: right;;">
                        {% for tag in post.tags.all %}
                            <span class="tag">#{{ tag.name }}   </span>
                        {% endfor %}
                        <i class="fa-solid fa-heart"></i>   {{post.thumbs_up}} 
                        <i class="fa-solid fa-eye"></i>   {{post.view_count}} 
                        <i class="fa-solid fa-comment"></i>   {{post.comment_count}} 
                    </span> 
                </p>    
            </div>
        </a>
        <script>
            fetch('/api/proxy_get_index_photo', { method: 'GET' })
            .then(function(response) {
                if (response.ok) {
                    // 获取代理的图片数据
                    return response.blob();
                } else {
                    console.log('Error:', response.statusText);
                }
            })
            .then(function(imageBlob) {
                if (imageBlob) {
                    // 创建URL对象，用于显示图片
                    const imageUrl = URL.createObjectURL(imageBlob);

                    // 修改原始代码，将图片设置为背景
                    var postID='{{ post.id|escapejs }}'
                    var cardElement = document.getElementById("post-" + postID);
                    cardElement.style.backgroundImage = "url('" + imageUrl + "')";
                }
            })
            .catch(function(error) {
                console.log('Error:', error);
            });
            </script>
        {% endfor %}
    </div>
</div>
<script>
var tag_data
function fetchData() {
  return new Promise((resolve, reject) => {
    // 发起Ajax请求
    $.ajax({
      url: '/api/get_alltags',
    type: 'get',
    dataType:"json",
      success: function(response) {
        tag_data = JSON.parse(response);
        resolve(); // 标志请求成功
      },
      error: function(xhr, status, error) {
        reject(error); // 标志请求失败
      }
    });
  });
}
fetchData()
  .then(() => {
    layui.use(function(){
    var dropdown = layui.dropdown;
      // 渲染
      dropdown.render({
        
        elem: '.article-choose', // 绑定元素选择器，此处指向 class 可同时绑定多个元素
        data: [{
          title: '默认排序',
          id: 101
        },{
          title: '按点赞数排序',
          id: 102
        },{
            title: '按浏览量排序',
            id: 103,
        },{
            title: '按评论数排序',
            id: 104,
        },{
          title: '标签筛选',
          id: 1001,
          child: tag_data
        }],
        click: function(obj){
          this.elem.find('span').text(obj.title);
            console.log(obj.id)
            if (obj.id == 101) {
                tar_id = -1
            }else if (obj.id == 102) {
                tar_id = -2
            }else if (obj.id == 103) {
                tar_id = -3
            }else if (obj.id == 104) {
                tar_id = -4
            }else{
                tar_id = obj.id
            }
            $.ajax({
                    url: '/api/filter_articles',
                    type: 'get',
                    data: {tag_id: tar_id},
                    success: function(data) {
                        article_list = JSON.parse(data);
                        console.log(article_list)
                        html=join_html(article_list)
                        // 更新 post 的内容
                        $('.post-list').html(html);
                    }
                });
        }
      });
        }
  )});
function join_html(data){
    var html = '';
    for (var i = 0; i < article_list.length; i++) {
        var data = article_list[i];
        html += '<a href="/post?id=' + data.id + '" class="post-card">';
        html += '<div class="post-card-img" id="post-' + data.id + '"></div>';
        html += '<div class="post-card-text">';
        html += '<h2>' + data.title + '</h2>';
        html += '<p>';
        html += '<span style="float: left;">' + data.author + ' ' + data.created_at + '</span>';
        html += '<span style="float: right;">';
            for (var j = 0; j < data.tags__name.length; j++) {
                if (tag__name != null) {
                    var tag__name = data.tags__name[j];
                html += '<span class="tag">#' + tag__name + '\t</span>';
                }
            }
            
        html += '<i class="fa-solid fa-heart"></i>\t'+data.thumbs_up + '\t';
        html += '<i class="fa-solid fa-eye"></i>\t' +data.view_count + '\t';
        html += '<i class="fa-solid fa-comment"></i>'+data.comment_count + '\t';
        html += '</span></p></div></a>';
        html += `
        <script>
        fetch('/api/proxy_get_index_photo', { method: 'GET' })
        .then(function(response) {
            if (response.ok) {
                // 获取代理的图片数据
                return response.blob();
            } else {
                console.log('Error:', response.statusText);
            }
        })
        .then(function(imageBlob) {
            if (imageBlob) {
                // 创建URL对象，用于显示图片
                const imageUrl = URL.createObjectURL(imageBlob);

                // 修改原始代码，将图片设置为背景
                var postID=`+ data.id +
                `;var cardElement = document.getElementById("post-" + postID);
                cardElement.style.backgroundImage = "url('" + imageUrl + "')";
            }
        })
        .catch(function(error) {
            console.log('Error:', error);
        });
        <\/script>`;
    }
    return html;
}
</script>
{% endblock %}