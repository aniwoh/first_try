{% extends "./layout-index.html" %}
{% block content %}
<link rel="stylesheet" href="{% static 'css/index_style.css' %}">
<div class="main-container">
    <button class="layui-btn layui-btn-primary layui-btn-radius article-choose" style="right: 10px; position: absolute;">
        <span>文章筛选</span>
        <i class="layui-icon layui-icon-down layui-font-12"></i>
      </button>
    <div class="post">
        {% for post in posts %}
        <a href="{% url 'post' %}?id={{ post.id }}" class="post-card">
            <div class="post-card-img" id="post-{{post.id}}"></div>
            <div class="post-card-text">
                <h2>{{ post.title }}</h2>
                <p>
                    <span style="float: left;">{{ post.author }} {{ post.created_at }} </span>
                    <span style="float: right;;">
                        {% for tag in post.tags.all %}
                            <span class="tag">#{{ tag.name }}   </span>
                        {% endfor %}
                        <i class="fa-solid fa-heart"></i>   {{post.thumbs_up}} 
                        <i class="fa-solid fa-eye"></i>   {{post.view_count}} 
                        <i class="fa-solid fa-comment"></i>   {{post.comment_count}} 
                    </span> 
                </p>    
            </div>
        </a>
        <script>
            fetch('/api/proxy', { method: 'GET' })
            .then(function(response) {
                if (response.ok) {
                    // 获取代理的图片数据
                    return response.blob();
                } else {
                    console.log('Error:', response.statusText);
                }
            })
            .then(function(imageBlob) {
                if (imageBlob) {
                    // 创建URL对象，用于显示图片
                    const imageUrl = URL.createObjectURL(imageBlob);

                    // 修改原始代码，将图片设置为背景
                    var postID='{{ post.id|escapejs }}'
                    var cardElement = document.getElementById("post-" + postID);
                    cardElement.style.backgroundImage = "url('" + imageUrl + "')";
                }
            })
            .catch(function(error) {
                console.log('Error:', error);
            });
            </script>
        {% endfor %}
    </div>
</div>
<script>
    layui.use(function(){
      var dropdown = layui.dropdown;
      // 渲染
      dropdown.render({
        elem: '.article-choose', // 绑定元素选择器，此处指向 class 可同时绑定多个元素
        data: [{
          title: '默认排序',
          id: 100
        },{
          title: '按点赞数排序',
          id: 101
        },{
            title: '按评论数排序',
            id: 102,
        },{
          title: '标签筛选',
          id: 1001,
          child: {{ tag_data|safe }},
        }],
        click: function(obj){
          this.elem.find('span').text(obj.title);
            console.log(obj.id)
            if (obj.id == 100) {
                tar_id = -1
            }else if (obj.id == 101) {
                tar_id = -2
            }else if (obj.id == 102) {
                tar_id = -3
            }else{
                tar_id = obj.id
            }
            $.ajax({
                    url: '/index/filter_articles',
                    type: 'get',
                    data: {tag_id: tar_id},
                    success: function(data) {
                        // 更新 post 的内容
                        $('.post').html(data);
                    }
                });
        }
      });
    })
    </script>
{% endblock %}